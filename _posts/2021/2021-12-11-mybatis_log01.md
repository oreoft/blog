---
layout: post
title: Mybatis-Plusçš„Sqlæ€§èƒ½åˆ†ææ—¥å¿—æ‰“å°
excerpt: è§£å†³Mybatis-Plus3.2ä»¥ä¸Šç‰ˆæœ¬å·²ç»ç§»é™¤æ€§èƒ½åˆ†ææ’ä»¶æ— æ³•æ‰“å°sqlæ—¥å¿—é—®é¢˜
category: java
keywords: java, middleware, mybatis
lang: zh
---

## å‰è¨€

ä¸Šæ¬¡é¡¹ç›®ä¸­å¼•å…¥Mybatis-Plus(åå­—æ—¶é—´å¤ªé•¿äº†ï¼Œåé¢**ç®€ç§°MP**)ï¼Œæˆ‘ä¹ æƒ¯æ€§åœ¨æœ¬åœ°å¼€å¯æ€§èƒ½åˆ†ææ’ä»¶æ–¹ä¾¿æ‰“å°sqlçš„ä¿¡æ¯ï¼Œä½†æ˜¯è¿™ä¸€æ¬¡å±…ç„¶æ‰¾ä¸åˆ°`PerformanceInterceptor`è¿™ä¸ªç±»ï¼Œåé¢æŸ¥çœ‹MPçš„[æ›´æ–°æ—¥å¿—](https://github.com/baomidou/mybatis-plus/releases)å‘ç°ï¼Œå±…ç„¶åœ¨`3.2`ç‰ˆæœ¬ç§»é™¤äº†`PerformanceInterceptor`ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­å¼•å…¥çš„æ˜¯`3.4.0`ç‰ˆæœ¬ã€‚

![image-20211211161132263](https://mypicgogo.oss-cn-hangzhou.aliyuncs.com/tuchuang20211211161132.png)

<center>MPçš„GIthubä¸Šreleaseæ—¥å¿—</center>

å…¶ä¸­æåˆ°å»ºè®®ä½¿ç”¨`p6spy`æ›¿ä»£ï¼Œç»è¿‡æˆ‘ä¸€ç•ªç ”ç©¶æˆ‘æ€»ç»“äº†ä¸‰ä¸ªæ‰“å°sqlæ—¥å¿—çš„æ–¹æ³•ï¼Œç‰¹æ„æ¥åˆ†äº«ä¸€ä¸‹ã€‚

æœ¬é¡¹ç›®ä»£ç å·²ç»ä¸Šä¼ è‡³Githubï¼Œ[ç‚¹å‡»è¿™é‡Œ](https://github.com/oreoft/project-store/tree/master/mybatis-sql-log)



## ä¸‰ç§æ–¹æ³•

å¦å¤–ï¼å¦å¤–ï¼å¦å¤–ï¼æ‰“å°Sqlæ—¥å¿—å¯¹æ‰§è¡Œçš„æ€§èƒ½å½±å“è¿˜ç®—æŒºå¤§çš„ï¼Œ**ç”Ÿäº§ç¯å¢ƒä¸Šå¯åƒä¸‡ä¸è¦å¯ç”¨**ï¼Œæˆ‘ä¸€èˆ¬åœ¨æœ¬åœ°Debugçš„æ—¶å€™å¼€å¯ï¼Œå°¤å…¶æ˜¯å¾®æœåŠ¡çš„è·¨æ¨¡å—è°ƒç”¨çœŸçš„æ˜¯å¤ªå¤ªå¤ªå¥½ç”¨äº†ï¼Œåªéœ€è¦è°ƒç”¨æ–¹æ‰“æ–­ç‚¹ï¼Œè¢«è°ƒç”¨æ–¹çš„è¯åªéœ€è¦æŠŠè¿™ä¸ªSqlæ‰“å‡ºæ¥ã€‚å¦‚æœæ•°æ®ä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™çœ‹ä¸€ä¸‹æ§åˆ¶å°æ‰“å°çš„Sqlæˆ–è€…æŠŠSqlæ”¾åˆ°DataGripé‡Œé¢è·‘ä¸€ä¸‹çœ‹çœ‹ã€‚

åœ¨dbé‡Œé¢åˆ›å»ºä¸€å¼ æ–¹ä¾¿æµ‹è¯•çš„è¡¨ï¼Œæˆ‘è¿™é‡Œæ˜¯åœ¨`test`çš„æ•°æ®åº“ä¸‹åˆ›å»ºä¸€å¼ `t_user`è¡¨é™„ä¸ŠDDL

```sql
create table t_user
(
    id          int unsigned primary key auto_increment comment 'pk',
    username    varchar(255) not null default '' comment 'ç”¨æˆ·å',
    password    varchar(100) not null default '123456' comment 'ç”¨æˆ·å¯†ç ',
    gender      char         not null default '0' comment 'æ€§åˆ«',
    phone       varchar(30)  not null default '' comment 'æ‰‹æœº',
    create_time datetime     not null default CURRENT_TIMESTAMP comment 'åˆ›å»ºæ—¶é—´'
) comment 'ç”¨æˆ·è¡¨';
```

æå‰å¯¼å…¥ğŸ”—

```xml
<dependency>
  	<groupId>mysql</groupId>
  	<artifactId>mysql-connector-java</artifactId>
  	<version>8.0.19</version>
</dependency>
<dependency>
  	<groupId>com.baomidou</groupId>
  	<artifactId>mybatis-plus-boot-starter</artifactId>
  	<!-- å…ˆéšä¾¿å¯¼å…¥ä¸€ä¸ªç‰ˆæœ¬ -->
  	<version>3.1.2</version>
</dependency>
```

ç„¶ååˆ›å»ºä¸€ä¸ªBO

```java
@Data
@TableName("t_user")
public class TUser {

    /**
     * pk
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * æ¨¡æ‹Ÿç”¨æˆ·åå­—
     */
    private String username;

    /**
     * æ¨¡æ‹Ÿç”¨æˆ·å¯†ç , æ–¹ä¾¿æ¼”ç¤º æ˜æ–‡å­˜å‚¨
     */
    private String password;

    /**
     * æ¨¡æ‹Ÿç”¨æˆ·æ€§åˆ«
     */
    private Integer gender;

    /**
     * æ¨¡æ‹Ÿç”¨æˆ·æ‰‹æœº
     */
    private String phone;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private LocalDateTime createTime;

}
```

ç„¶åå†™ä¸€ä¸ªMapper

```java
@Mapper
public interface TUserMapper extends BaseMapper<TUser> {
}
```

æœ€åå†™ä¸€ä¸ª**Testæ‰§è¡Œç±»**

```java
public class MybatisSqlLogTest {

    /**
     * å·æ‡’, ç”¨mapperæ¥æ¼”ç¤ºæŸ¥è¯¢æ—¥å¿—å±•ç¤ºæ•ˆæœ
     */
    @Resource
    private TUserMapper tUserMapper;

    @Test
    public void selectPrintLogTest() {
        LambdaQueryWrapper<TUser> query = new LambdaQueryWrapper<TUser>()
                .select(TUser::getId, TUser::getPhone, TUser::getGender)
                .eq(TUser::getGender, 0)
                .likeRight(TUser::getUsername, "å°");
        TUser result = tUserMapper.selectOne(query);
        System.out.printf("æŸ¥è¯¢åˆ°çš„idæ˜¯%s, ç”µè¯æ˜¯%s\n", result.getId(), result.getPhone());
    }
}
```



### å¼€å¯Mybatisçš„æ—¥å¿—æ‹¼æ¥åŠŸèƒ½

è¿™ä¸ªæ˜¯mybatiså°±è‡ªå¸¦çš„åŠŸèƒ½ï¼Œå¼€å¯æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ä½ çš„é…ç½®æ–‡ä»¶é‡Œé¢æŠŠä¸‹é¢è¿™è¡ŒåŠ ä¸Šå³å¯ï¼Œä¸€èˆ¬æˆ‘ä»¬æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå»ºè®®åªåœ¨devå¼€å¯ï¼Œé‚£ä¹ˆè¿™ä¸€è¡Œåªéœ€è¦åŠ åˆ°devçš„é…ç½®æ–‡ä»¶é‡Œé¢å°±å¥½å•¦ã€‚

```xml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

`mybatis-plus`å¼€å¤´çš„åŸå› æ˜¯å› ä¸ºMPä¹Ÿå…¼å®¹mybatisçš„é…ç½®ï¼Œé¡¶å±‚çš„keyæ¢æˆ`mybatis: `ä¹Ÿå¯ä»¥ç”Ÿæ•ˆã€‚

**æœ€åæµ‹è¯•ç±»æ¥æ‰§è¡Œä¸€ä¸‹(ä¸Šé¢çš„å‡†å¤‡å·¥ä½œæœ‰demoï¼Œç¿»ä¸Šå»çœ‹ä¸€ä¸‹)**

è¿™ä¸ªç¼ºç‚¹å°±æ˜¯ï¼Œè¾“å‡ºçš„æ—¥å¿—å¹¶éæ‰§è¡Œæ—¥å¿—ï¼Œæ—¥å¿—æ ¼å¼éœ€è¦è‡ªå·±æ‹¼æ¥ã€‚è¾“å‡ºçš„ç»“æœå¦‚ä¸‹

```tex
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@16132f21] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1271323139 wrapping com.mysql.cj.jdbc.ConnectionImpl@4f59a516] will not be managed by Spring
==>  Preparing: SELECT id,phone,gender FROM t_user WHERE gender = ? AND username LIKE ? 
==> Parameters: 0(Integer), å°%(String)
<==    Columns: id, phone, gender
<==        Row: 1, 13333333333, 0
<==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@16132f21]
```

ä½ éœ€è¦æŠŠå«æœ‰`==>`çš„ä¸¤è¡Œæ”¾åˆ°ä¸€äº›æ’ä»¶æˆ–è€…ä¸‰æ–¹å·¥å…·é‡Œé¢è¿›è¡Œè½¬æ¢ï¼Œä¾‹å¦‚æˆ‘æ˜¯ç”¨`uTools`é‡Œé¢çš„mybatisLogå·¥å…·è½¬æ¢ç»“æœå¦‚ä¸‹

![image-20211211165040675](https://mypicgogo.oss-cn-hangzhou.aliyuncs.com/tuchuang20211211165040.png)

<center>ä¸‰æ–¹å·¥å…·</center>

è¿™ç§è™½ç„¶æ˜¯åŸç”Ÿï¼Œä½†æ˜¯ç•¥æ˜¾éº»çƒ¦ï¼Œä¸æ˜¯å¾ˆç›´è§‚ï¼Œå¦‚æœæ˜¯sqlç‰¹åˆ«é•¿ï¼Œä¸€æ¬¡è¯·æ±‚ä¼šè¯ç‰¹åˆ«å¤šï¼Œçœ‹äº†å’Œæ²¡çœ‹ä¸€ä¸ªæ ·ã€‚

### MP 3.2ä»¥ä¸‹ç‰ˆæœ¬ä½¿ç”¨æ’ä»¶

ä½¿ç”¨MPåœ¨3.2ä»¥ä¸‹ç‰ˆæœ¬æä¾›çš„`PerformanceInterceptor`æ’ä»¶ï¼Œè¿™ä¸€ç§æ–¹å¼æ˜¯æˆ‘åŸæ¥ç”¨çš„æœ€å¤šï¼Œä¹Ÿç”¨çš„æœ€é¡ºæ‰‹çš„ï¼Œé…ç½®èµ·æ¥ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„åšç¯å¢ƒåŒºåˆ†ã€‚

ä½¿ç”¨æ–¹æ³•å’ŒMPå…¶ä»–æ’ä»¶ä¾‹å¦‚åˆ†é¡µæ’ä»¶ä¸€æ ·ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªbeanï¼Œè®¾ç½®å¥½è¾“å…¥ç„¶åæ”¾å…¥iocä¸­å³å¯ï¼ŒMPè¿è¡Œçš„æ—¶å€™å°±ä¼šä½¿ç”¨ä½ çš„beanå®Œæˆç›¸åº”çš„æ’ä»¶åŠŸèƒ½ã€‚

é¦–å…ˆç¡®è®¤å¥½ä½ çš„MPç‰ˆæœ¬æ˜¯åœ¨3.2ä¸€ä¸‹

```xml
<dependency>
  	<groupId>com.baomidou</groupId>
  	<artifactId>mybatis-plus-boot-starter</artifactId>
  	<!-- ç¡®å®šç‰ˆæœ¬å·æ˜¯3.2ä»¥ä¸‹ -->
  	<version>3.1.2</version>
</dependency>
```

ç„¶ååˆ›å»ºä¸€ä¸ªé…ç½®ç±»ï¼Œ ç„¶ååœ¨é‡Œé¢æ³¨å…¥ä¸€ä¸ª`PerformanceInterceptor`çš„bean

```java
@Configuration
public class MybatisPlusSqlLogConfig {


    /**
     * æ‰“å° sqlï¼Œæ€§èƒ½åˆ†ææ‹¦æˆªå™¨
     * å› ä¸ºæ¯æ¬¡sqléƒ½éœ€è¦åšæ‹¦æˆª, ä¼šæœ‰æ€§èƒ½æŸè€—
     * æ‰€ä»¥å»ºè®®åªåœ¨devæˆ–è€…testç¯å¢ƒä¸‹æ–¹ä¾¿debugçš„æ—¶å€™æŸ¥çœ‹
     * å¦‚æœå¤šä¸ªç¯å¢ƒ -> @Profile({"dev", "test"})
     * @return PerformanceInterceptor bean
     */
    @Bean
    @Profile("mp")
    public PerformanceInterceptor performanceInterceptor() {
        PerformanceInterceptor performanceInterceptor = new PerformanceInterceptor();
        // è®¾ç½®æ ¼å¼åŒ–, ç±»ä¼¼äºdatagripçš„ç¾åŒ–sqlè¯­å¥, åœ¨æ§åˆ¶å°å¥½çœ‹ä¸€äº›
        performanceInterceptor.setFormat(true);
        return performanceInterceptor;
    }
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨@Beanåé¢å¯ä»¥å†æ‰“ä¸€ä¸ªæ³¨è§£`@Profile("dev")`ï¼Œåªè¦ä½ çš„devé…ç½®æ–‡ä»¶æ˜¯`application-dev.yml`ï¼Œé‚£ä¹ˆè¿™ä¸ªbeanåªä¼šåœ¨devç¯å¢ƒé‡Œé¢æ³¨å…¥ã€‚åœ¨ç”Ÿäº§ä¸Šä½ ä¹Ÿä¸ç”¨æ‹…å¿ƒè¿™ä¸ªä¼šå½±å“æ€§èƒ½å•¦ï¼Œå› ä¸ºæˆ‘ä»£ç ä¸­æ˜¯mp-è¡¨ç¤ºçš„æ’ä»¶demoï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œåªåœ¨mpä¸‹ç”Ÿæ•ˆã€‚

**æœ€åæµ‹è¯•ç±»æ¥æ‰§è¡Œä¸€ä¸‹(ä¸Šé¢çš„å‡†å¤‡å·¥ä½œæœ‰demoï¼Œç¿»ä¸Šå»çœ‹ä¸€ä¸‹)**

ç„¶åç»“æœå¦‚ä¸‹ï¼Œè¿™æ ·çš„æ•ˆæœå°±éå¸¸çš„ç›´è§‚ï¼Œå¹¶ä¸”è¿˜æ˜¯çº¢è‰²å­—ä½“

```tex
 Timeï¼š22 ms - IDï¼šcn.someget.mybatis.sqllog.mapper.TUserMapper.selectOne
Execute SQLï¼š
    SELECT
        id,
        phone,
        gender 
    FROM
        t_user 
    WHERE
        gender = 0 
        AND username LIKE 'å°%'

æŸ¥è¯¢åˆ°çš„idæ˜¯1, ç”µè¯æ˜¯13333333333
```

![image-20211211171904411](https://mypicgogo.oss-cn-hangzhou.aliyuncs.com/tuchuang20211211171904.png)

<center>çº¢è‰²é†’ç›®å­—ä½“</center>

æœ¬æ¥æ˜¯éå¸¸å¥½ç”¨çš„ï¼Œå¯èƒ½æ˜¯ä½œè€…è§‰å¾—è¿™ä¸ªå¯¹æ€§èƒ½å½±å“éå¸¸å¤§ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸ªæ’ä»¶å¤§å®¶è¯¯ç”¨å°±åœ¨3.2ç‰ˆæœ¬ä¸­ä¸‹æ¶äº†....

### MP 3.2åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨p6spy

é‚£æˆ‘å·²ç»æ˜ç¡®çŸ¥é“è¿™ä¸ªæ˜¯ä¸é€‚åˆä¸Šç”Ÿäº§ï¼Œä½†æ˜¯æˆ‘ç°åœ¨æœ¬åœ°æ–¹ä¾¿debugçœ‹ï¼Œé™¤äº†é™ä½MPç‰ˆæœ¬ï¼Œé‚£è¿˜æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ã€‚ä½œè€…ä¹Ÿåœ¨æ›´æ–°æ—¥å¿—ä¸­æåˆ°æ¨èä½¿ç”¨`p6spy`ã€‚

*P6Spy*æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥åœ¨åº”ç”¨ç¨‹åºä¸­æ‹¦æˆªå’Œä¿®æ”¹æ•°æ®æ“ä½œè¯­å¥çš„å¼€æºæ¡†æ¶ï¼ŒGitHubåœ°å€è¯·[ç‚¹å‡»è¿™é‡Œ](https://github.com/p6spy/p6spy)ã€‚å®ƒçš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œè¿™é‡Œåªä»‹ç»å®ƒæ»¡è¶³sqlæ€§èƒ½åˆ†æå’Œæ—¥å¿—è¾“å‡ºçš„éœ€æ±‚ã€‚

é¦–å…ˆå…ˆå¯¼å…¥ä»–çš„ä¾èµ–ï¼Œæˆ‘è¿™é‡Œéšä¾¿å¯¼å…¥ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ‰€æœ‰ç‰ˆæœ¬è¯·[ç‚¹å‡»è¿™é‡Œ](https://mvnrepository.com/artifact/p6spy/p6spy)

```xml
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.8.2</version>
</dependency>
```

ç„¶åå†é…ç½®æ–‡ä»¶é‡Œé¢é…ç½®datasourceè¿æ¥çš„æ—¶å€™ï¼Œæ›´æ¢é©±åŠ¨ç±»åä»¥åŠurl

```yml
# é…ç½®ä¸€ä¸‹mysqlçš„è¿æ¥ä¿¡æ¯
spring:
  datasource:
#   driver-class-name: com.mysql.cj.jdbc.Driver è¿™æ˜¯åŸæ¥çš„
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
#   url: jdbc:mysql://${mysql.host} è¿™æ˜¯åŸæ¥çš„urlå¤´éƒ¨
    url: jdbc:p6spy:mysql://${mysql.host}:3306/test?useUnicode=true&characterEncoding=utf8&autoReconnect=true&failOverReadOnly=false&useSSL=false
    username: root
    password: 123456
```

æœ€ååœ¨`resources`åˆ›å»ºä¸€ä¸ª`spy.properties`çš„æ–‡ä»¶é‡Œé¢å†™å…¥ä¸€äº›åŸºæœ¬é…ç½®

```yml
#æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°
appender=com.baomidou.mybatisplus.extension.p6spy.StdoutLogger

# æ ¼å¼åŒ–(ä¸è®¾ç½®çš„è¯ä¸€å¤§ä¸²é˜…è¯»æ€§ä¸å¼º, è¿™ä¸ªæ˜¯å†…ç½®çš„æ ¼å¼å™¨å¯ä»¥æŒ‰ç…§æºç è‡ªå·±å†™ä¸€ä¸ªç„¶åé…ç½®)
logMessageFormat=com.baomidou.mybatisplus.extension.p6spy.P6SpyLogger

# å–æ¶ˆJDBCçš„urlå‰ç¼€
useprefix=true
```

p.s. æ³¨æ„p6spyåªéœ€è¦å¯¼åŒ…å’Œåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å³å¯ï¼Œä¸éœ€è¦ç¼–å†™ä»£ç 

**æœ€åæµ‹è¯•ç±»æ¥æ‰§è¡Œä¸€ä¸‹(ä¸Šé¢çš„å‡†å¤‡å·¥ä½œæœ‰demoï¼Œç¿»ä¸Šå»çœ‹ä¸€ä¸‹)**

```tex
 Consume Timeï¼š10 ms 1639215721188
 Execute SQLï¼šSELECT id,phone,gender FROM t_user WHERE gender = 0 AND username LIKE 'å°%'

æŸ¥è¯¢åˆ°çš„idæ˜¯1, ç”µè¯æ˜¯13333333333
```

![image-20211211174242855](https://mypicgogo.oss-cn-hangzhou.aliyuncs.com/tuchuang20211211174242.png)

çœ‹èµ·æ¥ä¹Ÿå¾ˆç›´è§‚ï¼Œä½†æ˜¯æˆ‘ç¿»äº†ä¸€ä¸‹æºç ï¼Œå¥½åƒæ²¡æœ‰è‡ªå¸¦æ ¼å¼åŒ–çš„é…ç½®ç±»ï¼Œå¦‚æœå¤§å®¶æœ‰æ ¼å¼åŒ–éœ€æ±‚ï¼Œå¯ä»¥ç»§æ‰¿`MessageFormattingStrategy`è‡ªå·±ç…§ç€`P6SpyLogger`å†™ä¸€ä¸ªã€‚



## åè¨€

ä¸€èˆ¬åŸºç¡€ç»„ä»¶ï¼Œåˆ›å»ºé¡¹ç›®çš„æ—¶å€™å°±ä¼šé€‰æ‹©ä¸€ä¸ªç¨³å®šç‰ˆå¼€å§‹æ­å»ºã€‚åæœŸä¸Šç”Ÿäº§ç¨³å®šä»¥åä¸€èˆ¬éƒ½æ˜¯é”ç‰ˆæœ¬çš„ï¼Œæˆ‘ä¹Ÿæ˜¯æœ€è¿‘æ–°é¡¹ç›®å¼•å…¥MPæ‰å‘ç°å±…ç„¶æ€§èƒ½åˆ†æçš„æ’ä»¶å·²ç»è¢«ç§»é™¤äº†ï¼Œç‰¹æ„è®°å½•ä¸€ä¸‹ï¼Œç»™ä¹Ÿä¹ æƒ¯åœ¨æœ¬åœ°å¼€å¯sqlæ—¥å¿—è¾“å‡ºçš„äººæä¸ªé†’ã€‚

æœ€åè¿™ä¸ªæœ¬åœ°debugçœ‹ä¸€ä¸‹æ˜¯çœŸçš„çˆ½ï¼Œä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒæ‰“å¼€å“ˆã€‚
